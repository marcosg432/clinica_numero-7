<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="api-url" content="__API_URL__">
  <title>Painel Admin - Cl√≠nica Odonto Azul</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
    }
    .login-form {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 50px auto;
    }
    .login-form h2 {
      margin-bottom: 20px;
      color: #0A4DA2;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      font-family: inherit;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    button {
      padding: 12px 24px;
      background: #0A4DA2;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    button:hover {
      background: #0b61d1;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    .dashboard {
      display: none;
    }
    .dashboard.active {
      display: block;
    }
    header {
      background: linear-gradient(135deg, #0A4DA2, #0b61d1);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h1 {
      font-size: 24px;
    }
    .nav-tabs {
      background: white;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      padding: 0 30px;
      gap: 0;
      overflow-x: auto;
    }
    .nav-tabs button {
      padding: 15px 24px;
      background: transparent;
      color: #666;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s;
      white-space: nowrap;
    }
    .nav-tabs button:hover {
      background: #f8f9fa;
      color: #0A4DA2;
    }
    .nav-tabs button.active {
      color: #0A4DA2;
      border-bottom-color: #0A4DA2;
      background: transparent;
    }
    .page-content {
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .page-header h2 {
      color: #0A4DA2;
      font-size: 24px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .stat-card h3 {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .stat-card .number {
      font-size: 32px;
      font-weight: bold;
      color: #0A4DA2;
    }
    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    .status.PENDENTE { background: #fff3cd; color: #856404; }
    .status.CONFIRMADO { background: #d4edda; color: #155724; }
    .status.CANCELADO { background: #f8d7da; color: #721c24; }
    .actions {
      display: flex;
      gap: 8px;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
    }
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filters button {
      padding: 8px 16px;
      font-size: 14px;
    }
    .filters button.active {
      background: #0b61d1;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h3 {
      color: #0A4DA2;
      font-size: 20px;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 30px;
      height: 30px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.success { background: #d4edda; color: #155724; }
    .badge.danger { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="login-section" class="login-form">
    <h2>üîê Login Admin</h2>
    <div id="login-error"></div>
    <input type="email" id="email" placeholder="Email" value="admin@clinicaodontoazul.com.br">
    <input type="password" id="password" placeholder="Senha" value="">
    <p style="font-size: 12px; color: #666; margin-top: -10px; margin-bottom: 15px;">
      üí° Email: <code>admin@clinicaodontoazul.com.br</code><br>
      üîë Senha: Verifique no Railway (vari√°vel ADMIN_PASSWORD)
    </p>
    <button onclick="login()">Entrar</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <header>
      <h1>üìä Painel Administrativo</h1>
      <button class="danger" onclick="logout()">Sair</button>
    </header>

    <div class="nav-tabs">
      <button onclick="showPage('dashboard')" class="active">üìä Dashboard</button>
      <button onclick="showPage('tratamentos')">ü¶∑ Tratamentos</button>
      <button onclick="showPage('agendamentos')">üìÖ Agendamentos</button>
      <button onclick="showPage('avaliacoes')">‚≠ê Avalia√ß√µes</button>
    </div>

    <div class="page-content">
      <!-- Dashboard Page -->
      <div id="page-dashboard" class="page active">
        <h2>Dashboard</h2>
        <div class="stats">
          <div class="stat-card">
            <h3>Tratamentos</h3>
            <div class="number" id="stat-tratamentos">-</div>
          </div>
          <div class="stat-card">
            <h3>Agendamentos</h3>
            <div class="number" id="stat-agendamentos">-</div>
          </div>
          <div class="stat-card">
            <h3>Avalia√ß√µes</h3>
            <div class="number" id="stat-avaliacoes">-</div>
          </div>
          <div class="stat-card">
            <h3>Avalia√ß√µes Pendentes</h3>
            <div class="number" id="stat-pendentes">-</div>
          </div>
        </div>
      </div>

      <!-- Tratamentos Page -->
      <div id="page-tratamentos" class="page">
        <div class="page-header">
          <h2>ü¶∑ Tratamentos</h2>
          <button onclick="openTratamentoModal()">+ Novo Tratamento</button>
        </div>
        <div class="section">
          <div id="tratamentos-loading" class="loading">Carregando...</div>
          <table id="tratamentos-table" style="display: none;">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Descri√ß√£o</th>
                <th>Slug</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tratamentos-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Agendamentos Page -->
      <div id="page-agendamentos" class="page">
        <div class="page-header">
          <h2>üìÖ Agendamentos</h2>
        </div>
        <div class="filters">
          <button onclick="filterAgendamentos(null)" class="active">Todos</button>
          <button onclick="filterAgendamentos('PENDENTE')">Pendentes</button>
          <button onclick="filterAgendamentos('CONFIRMADO')">Confirmados</button>
          <button onclick="filterAgendamentos('CANCELADO')">Cancelados</button>
        </div>
        <div class="section">
          <div id="agendamentos-loading" class="loading">Carregando...</div>
          <table id="agendamentos-table" style="display: none;">
            <thead>
              <tr>
                <th>Data</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Telefone</th>
                <th>Tratamento</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="agendamentos-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Avalia√ß√µes Page -->
      <div id="page-avaliacoes" class="page">
        <div class="page-header">
          <h2>‚≠ê Avalia√ß√µes</h2>
          <button onclick="openAvaliacaoModal()">+ Nova Avalia√ß√£o</button>
        </div>
        <div class="section">
          <div id="avaliacoes-loading" class="loading">Carregando...</div>
          <table id="avaliacoes-table" style="display: none;">
            <thead>
              <tr>
                <th>Data</th>
                <th>Nome</th>
                <th>Nota</th>
                <th>Texto</th>
                <th>Aprovado</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="avaliacoes-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Tratamento -->
  <div id="modal-tratamento" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-tratamento-title">Novo Tratamento</h3>
        <button class="close-btn" onclick="closeTratamentoModal()">&times;</button>
      </div>
      <div id="modal-tratamento-error"></div>
      <form id="form-tratamento" onsubmit="saveTratamento(event)">
        <input type="hidden" id="tratamento-id">
        <div class="form-group">
          <label>Nome *</label>
          <input type="text" id="tratamento-nome" required>
        </div>
        <div class="form-group">
          <label>Descri√ß√£o</label>
          <textarea id="tratamento-descricao"></textarea>
        </div>
        <div class="form-group">
          <label>Slug *</label>
          <input type="text" id="tratamento-slug" required>
        </div>
        <div class="form-group">
          <label>Imagem (URL)</label>
          <input type="text" id="tratamento-imagem">
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="tratamento-ativo" checked> Ativo
          </label>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" class="secondary" onclick="closeTratamentoModal()">Cancelar</button>
          <button type="submit">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Avalia√ß√£o -->
  <div id="modal-avaliacao" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-avaliacao-title">Nova Avalia√ß√£o</h3>
        <button class="close-btn" onclick="closeAvaliacaoModal()">&times;</button>
      </div>
      <div id="modal-avaliacao-error"></div>
      <form id="form-avaliacao" onsubmit="saveAvaliacao(event)">
        <input type="hidden" id="avaliacao-id">
        <div class="form-group">
          <label>Nome *</label>
          <input type="text" id="avaliacao-nome" required>
        </div>
        <div class="form-group">
          <label>Avatar (Iniciais)</label>
          <input type="text" id="avaliacao-avatar" maxlength="2" placeholder="Ex: GL">
        </div>
        <div class="form-group">
          <label>Nota *</label>
          <select id="avaliacao-nota" required>
            <option value="5">5 ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
            <option value="4">4 ‚≠ê‚≠ê‚≠ê‚≠ê</option>
            <option value="3">3 ‚≠ê‚≠ê‚≠ê</option>
            <option value="2">2 ‚≠ê‚≠ê</option>
            <option value="1">1 ‚≠ê</option>
          </select>
        </div>
        <div class="form-group">
          <label>Texto *</label>
          <textarea id="avaliacao-texto" required></textarea>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="avaliacao-aprovado" checked> Aprovado
          </label>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" class="secondary" onclick="closeAvaliacaoModal()">Cancelar</button>
          <button type="submit">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Configura√ß√£o din√¢mica da API URL
    (function() {
      function getApiUrl() {
        // 1. Tentar usar window.API_URL se j√° existir
        if (window.API_URL && !window.API_URL.includes('__API_URL__')) {
          return window.API_URL;
        }
        
        // 2. Tentar ler do meta tag
        const metaTag = document.querySelector('meta[name="api-url"]');
        if (metaTag && metaTag.content) {
          const metaUrl = metaTag.content.trim();
          // Rejeitar se cont√©m placeholder ou URL gen√©rica incorreta
          if (metaUrl && 
              metaUrl !== '__API_URL__' && 
              !metaUrl.includes('__API_URL__') && 
              !metaUrl.includes('seu-backend') &&
              metaUrl.startsWith('http')) {
            console.log('‚úÖ URL do meta tag v√°lida:', metaUrl);
            return metaUrl;
          } else {
            console.warn('‚ö†Ô∏è Meta tag cont√©m placeholder ou URL inv√°lida:', metaUrl);
          }
        }
        
        // 3. Fallback baseado no ambiente
        const isLocalhost = window.location.hostname === 'localhost' || 
                            window.location.hostname === '127.0.0.1' ||
                            window.location.hostname === '';
        
        return isLocalhost 
          ? 'http://localhost:3000/api' 
          : 'https://clinicanumero-7-production.up.railway.app/api';
      }
      
      window.API_URL = getApiUrl();
      console.log('üîß Admin - API URL configurada:', window.API_URL);
      
      // Verificar se a URL est√° correta
      if (window.API_URL.includes('seu-backend') || window.API_URL.includes('__API_URL__')) {
        console.error('‚ùå ERRO: API_URL cont√©m placeholder! For√ßando URL correta...');
        window.API_URL = 'https://clinicanumero-7-production.up.railway.app/api';
        console.log('‚úÖ API_URL corrigida para:', window.API_URL);
      }
    })();
    
    const API_URL = window.API_URL;
    console.log('üåê Admin - URL final que ser√° usada:', API_URL);
    let token = localStorage.getItem('adminToken');
    let refreshToken = localStorage.getItem('adminRefreshToken');
    let currentAgendamentoFilter = null;

    // Sistema de refresh autom√°tico de token
    async function refreshAccessToken() {
      if (!refreshToken) {
        console.warn('‚ö†Ô∏è Refresh token n√£o encontrado');
        return null;
      }

      try {
        console.log('üîÑ Renovando access token...');
        const response = await fetch(`${API_URL}/auth/refresh`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify({ refreshToken }),
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        if (data.success && data.data) {
          token = data.data.accessToken;
          refreshToken = data.data.refreshToken;
          localStorage.setItem('adminToken', token);
          localStorage.setItem('adminRefreshToken', refreshToken);
          console.log('‚úÖ Token renovado com sucesso');
          return token;
        }
      } catch (error) {
        console.error('‚ùå Erro ao renovar token:', error);
        // Token expirado - fazer logout
        logout();
        return null;
      }
    }

    // Fun√ß√£o helper para fazer requisi√ß√µes com retry autom√°tico em caso de 401
    async function apiRequest(url, options = {}) {
      const headers = {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        ...options.headers,
      };

      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      try {
        let response = await fetch(url, {
          ...options,
          headers,
          mode: 'cors',
        });

        // Se 401, tentar refresh e retry
        if (response.status === 401 && refreshToken) {
          console.log('üîÑ Token expirado, tentando renovar...');
          const newToken = await refreshAccessToken();
          if (newToken) {
            headers['Authorization'] = `Bearer ${newToken}`;
            response = await fetch(url, {
              ...options,
              headers,
              mode: 'cors',
            });
          }
        }

        return response;
      } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        throw error;
      }
    }

    // Expor fun√ß√µes globalmente para bot√µes
    window.loadTratamentos = loadTratamentos;
    window.loadAvaliacoes = loadAvaliacoes;
    window.diagnoseConnection = diagnoseConnection;

    // Fun√ß√£o para diagnosticar problemas
    async function diagnoseConnection() {
      const diagnostics = {
        apiUrl: API_URL,
        token: token ? 'Presente' : 'Ausente',
        refreshToken: refreshToken ? 'Presente' : 'Ausente',
        backendStatus: 'Desconhecido',
        cors: 'Desconhecido',
        auth: 'Desconhecido',
      };

      try {
        // Testar health check (sem auth)
        const healthResponse = await fetch(`${API_URL.replace('/api', '')}/health`);
        diagnostics.backendStatus = healthResponse.ok ? 'Online' : `Erro ${healthResponse.status}`;

        // Testar CORS
        try {
          const corsResponse = await fetch(`${API_URL}/tratamentos?limit=1`, {
            method: 'GET',
            headers: { 'Accept': 'application/json' },
            mode: 'cors',
          });
          diagnostics.cors = corsResponse.ok || corsResponse.status === 401 ? 'OK' : `Erro ${corsResponse.status}`;
        } catch (corsError) {
          diagnostics.cors = `Erro: ${corsError.message}`;
        }

        // Testar autentica√ß√£o
        if (token) {
          try {
            const authResponse = await apiRequest(`${API_URL}/auth/profile`);
            diagnostics.auth = authResponse.ok ? 'OK' : `Erro ${authResponse.status}`;
          } catch (authError) {
            diagnostics.auth = `Erro: ${authError.message}`;
          }
        }
      } catch (error) {
        diagnostics.error = error.message;
      }

      console.log('üîç Diagn√≥stico de Conex√£o:', diagnostics);
      return diagnostics;
    }

    // Testar conex√£o
    window.addEventListener('DOMContentLoaded', async () => {
      // Executar diagn√≥stico
      await diagnoseConnection();

      if (token) {
        checkAuth();
      }
    });

    // Fun√ß√µes tempor√°rias removidas - admin √© criado automaticamente no startup do servidor

    // Fun√ß√£o de login - deve estar no escopo global para ser acess√≠vel via onclick
    window.login = async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');

      errorDiv.innerHTML = '';

      console.log('üîê Tentando fazer login...');
      console.log('üìß Email:', email);
      console.log('üîó API URL:', API_URL);

      try {
        const loginUrl = `${API_URL}/auth/login`;
        console.log('üåê Fazendo requisi√ß√£o para:', loginUrl);
        
        const response = await fetch(loginUrl, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ email, password }),
          mode: 'cors'
        });

        console.log('üì• Resposta recebida:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå Erro HTTP:', response.status, errorText);
          let errorMessage = 'Erro ao fazer login';
          try {
            const errorData = JSON.parse(errorText);
            errorMessage = errorData.error?.message || errorData.message || errorMessage;
          } catch (e) {
            errorMessage = `Erro HTTP ${response.status}: ${errorText.substring(0, 100)}`;
          }
          errorDiv.innerHTML = `<div class="error">${errorMessage}</div>`;
          return;
        }

        const data = await response.json();
        console.log('‚úÖ Login bem-sucedido');

        if (data.data && data.data.accessToken) {
          token = data.data.accessToken;
          refreshToken = data.data.refreshToken;
          localStorage.setItem('adminToken', token);
          localStorage.setItem('adminRefreshToken', refreshToken);
          console.log('‚úÖ Login bem-sucedido, tokens salvos');
          document.getElementById('login-section').style.display = 'none';
          document.getElementById('dashboard').classList.add('active');
          loadDashboard();
        } else {
          errorDiv.innerHTML = `<div class="error">Token n√£o recebido do servidor</div>`;
        }
      } catch (error) {
        console.error('‚ùå Erro ao fazer login:', error);
        let errorMessage = `Erro de conex√£o: ${error.message}`;
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMessage = `Erro de conex√£o. Verifique se o backend est√° online. URL: ${API_URL.replace('/api', '')}/health`;
        } else if (error.message.includes('CORS')) {
          errorMessage = `Erro CORS: Configure FRONTEND_URL no Railway`;
        }
        errorDiv.innerHTML = `<div class="error">${errorMessage}</div>`;
      }
    }

    async function checkAuth() {
      try {
        const response = await fetch(`${API_URL}/auth/profile`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          document.getElementById('login-section').style.display = 'none';
          document.getElementById('dashboard').classList.add('active');
          loadDashboard();
        } else {
          console.warn('‚ö†Ô∏è Autentica√ß√£o falhou, fazendo logout...');
          logout();
        }
      } catch (error) {
        console.error('‚ùå Erro ao verificar autentica√ß√£o:', error);
        logout();
      }
    }

    function showPage(page) {
      // Atualizar tabs
      document.querySelectorAll('.nav-tabs button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Mostrar p√°gina
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${page}`).classList.add('active');

      // Carregar dados se necess√°rio
      if (page === 'tratamentos') loadTratamentos();
      else if (page === 'agendamentos') loadAgendamentos();
      else if (page === 'avaliacoes') loadAvaliacoes();
      else if (page === 'dashboard') loadStats();
    }

    async function loadDashboard() {
      await loadStats();
    }

    async function loadStats() {
      try {
        console.log('üìä Carregando estat√≠sticas...');
        
        // Usar apiRequest para todas as requisi√ß√µes autenticadas
        const [tratamentosResponse, agendamentosResponse, avaliacoesResponse] = await Promise.all([
          fetch(`${API_URL}/tratamentos?ativo=true&limit=100`).catch(e => ({ ok: false, json: () => ({ success: false }) })),
          apiRequest(`${API_URL}/agendamento?limit=100`, { method: 'GET' }).catch(e => ({ ok: false, json: () => ({ success: false }) })),
          fetch(`${API_URL}/avaliacoes?limit=100`).catch(e => ({ ok: false, json: () => ({ success: false }) }))
        ]);

        const [tratamentos, agendamentos, avaliacoes] = await Promise.all([
          tratamentosResponse.json ? tratamentosResponse.json() : { success: false },
          agendamentosResponse.json ? agendamentosResponse.json() : { success: false },
          avaliacoesResponse.json ? avaliacoesResponse.json() : { success: false }
        ]);

        document.getElementById('stat-tratamentos').textContent = 
          tratamentos.success ? (tratamentos.pagination?.total || tratamentos.data?.length || 0) : '-';
        document.getElementById('stat-agendamentos').textContent = 
          agendamentos.success ? (agendamentos.pagination?.total || agendamentos.data?.length || 0) : '-';
        document.getElementById('stat-avaliacoes').textContent = 
          avaliacoes.success ? (avaliacoes.pagination?.total || avaliacoes.data?.length || 0) : '-';

        if (avaliacoes.success) {
          const pendentes = avaliacoes.data?.filter(a => !a.aprovado).length || 0;
          document.getElementById('stat-pendentes').textContent = pendentes;
        }
      } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
      }
    }

    // Fun√ß√£o helper para processar resposta de tratamentos
    async function handleTratamentosResponse(response, loading, table, body) {
      const data = await response.json();
      console.log('‚úÖ Tratamentos recebidos:', data);
      console.log(`üìä Total: ${data.data?.length || 0} tratamentos`);

      console.log('üì¶ Processando resposta de tratamentos...');
      console.log('  - success:', data.success);
      console.log('  - data existe?', !!data.data);
      console.log('  - data √© array?', Array.isArray(data.data));
      console.log('  - quantidade:', data.data?.length || 0);
      
      if (data.success && data.data && Array.isArray(data.data)) {
        loading.style.display = 'none';
        table.style.display = 'table';

        if (data.data.length === 0) {
          body.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                <div style="margin-bottom: 10px;">üì≠ Nenhum tratamento encontrado no banco de dados</div>
                <div style="font-size: 0.9em; color: #999;">
                  Clique em "+ Novo Tratamento" para criar o primeiro.
                </div>
              </td>
            </tr>
          `;
          console.log('‚ö†Ô∏è Banco de dados est√° vazio para tratamentos');
        } else {
          body.innerHTML = data.data.map(t => `
          <tr>
            <td>${t.nome}</td>
            <td>${(t.descricao || '').substring(0, 80)}${(t.descricao || '').length > 80 ? '...' : ''}</td>
            <td>${t.slug}</td>
            <td>${t.ativo ? '<span class="badge success">Ativo</span>' : '<span class="badge danger">Inativo</span>'}</td>
            <td class="actions">
              <button class="btn-small" onclick="editTratamento('${t.id || ''}')">Editar</button>
              <button class="btn-small danger" onclick="deleteTratamento('${t.id || ''}', '${(t.nome || '').replace(/'/g, "\\'")}')">Excluir</button>
            </td>
          </tr>
          `).join('');
        }
      } else {
        loading.style.display = 'none';
        body.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px; color: #d32f2f;">
              <div style="margin-bottom: 10px;">‚ö†Ô∏è Erro ao processar resposta da API</div>
              <div style="font-size: 0.9em; color: #999;">
                Verifique o console (F12) para mais detalhes.<br>
                Resposta recebida: ${JSON.stringify(data).substring(0, 200)}...
              </div>
            </td>
          </tr>
        `;
        console.error('‚ùå Resposta da API n√£o cont√©m dados v√°lidos:', data);
        console.error('  - Estrutura esperada: { success: true, data: [...] }');
      }
    }

    // ============ TRATAMENTOS ============
    async function loadTratamentos() {
      const loading = document.getElementById('tratamentos-loading');
      const table = document.getElementById('tratamentos-table');
      const body = document.getElementById('tratamentos-body');

      try {
        loading.style.display = 'block';
        table.style.display = 'none';

        const url = `${API_URL}/tratamentos?limit=100&orderBy=criadoEm&order=desc`;
        console.log('üì• Carregando tratamentos do admin:', url);
        console.log('üîë Token presente:', !!token);
        
        // Usar apiRequest helper que faz refresh autom√°tico
        const response = await apiRequest(url, {
          method: 'GET',
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`‚ùå Erro HTTP ${response.status}:`, errorText);
          
          // Tentar sem token se for 401 (rota p√∫blica)
          if (response.status === 401) {
            console.log('‚ö†Ô∏è Tentando carregar sem autentica√ß√£o (rota p√∫blica)...');
            const publicResponse = await fetch(url, {
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
              },
            });
            
            if (publicResponse.ok) {
              console.log('‚úÖ Carregado via rota p√∫blica (sem auth)');
              return await handleTratamentosResponse(publicResponse, loading, table, body);
            }
          }
          
          throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
        }

        return await handleTratamentosResponse(response, loading, table, body);
      } catch (error) {
        console.error('‚ùå Erro ao carregar tratamentos:', error);
        console.error('  - Tipo:', error.name);
        console.error('  - Mensagem:', error.message);
        console.error('  - Stack:', error.stack);
        
        loading.style.display = 'none';
        const errorMsg = error.message || 'Erro desconhecido';
        loading.innerHTML = `
          <div class="error" style="padding: 20px; text-align: center;">
            <strong>‚ùå Erro ao carregar tratamentos</strong><br>
            <small>${errorMsg}</small><br><br>
            <button onclick="loadTratamentos()" class="btn-small" style="margin-top: 10px;">üîÑ Tentar Novamente</button>
            <button onclick="diagnoseConnection()" class="btn-small" style="margin-top: 10px;">üîç Diagnosticar Conex√£o</button>
          </div>
        `;
      }
    }

    // Fun√ß√£o para gerar slug a partir do nome (mesma l√≥gica do backend)
    function generateSlug(text) {
      return text
        .toString()
        .toLowerCase()
        .trim()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Remove acentos
        .replace(/\s+/g, '-') // Substitui espa√ßos por h√≠fens
        .replace(/[^\w\-]+/g, '') // Remove caracteres especiais
        .replace(/\-\-+/g, '-') // Remove m√∫ltiplos h√≠fens
        .replace(/^-+/, '') // Remove h√≠fens do in√≠cio
        .replace(/-+$/, ''); // Remove h√≠fens do fim
    }

    function openTratamentoModal(id = null) {
      const modal = document.getElementById('modal-tratamento');
      const title = document.getElementById('modal-tratamento-title');
      const form = document.getElementById('form-tratamento');
      const errorDiv = document.getElementById('modal-tratamento-error');
      const idInput = document.getElementById('tratamento-id');
      
      // Limpar erros
      errorDiv.innerHTML = '';
      
      // Validar ID antes de continuar
      const isEdit = id && id !== 'null' && id !== 'undefined' && id !== '';
      
      if (isEdit) {
        title.textContent = 'Editar Tratamento';
        // Limpar formul√°rio mas manter o ID input separado
        form.reset();
        if (idInput) idInput.value = id;
        // Carregar dados do tratamento
        loadTratamentoData(id);
      } else {
        title.textContent = 'Novo Tratamento';
        // Limpar tudo para novo tratamento
        form.reset();
        if (idInput) idInput.value = '';
        document.getElementById('tratamento-ativo').checked = true;
      }
      
      modal.classList.add('active');
      
      // Adicionar listener para gerar slug automaticamente quando nome mudar
      const nomeInput = document.getElementById('tratamento-nome');
      const slugInput = document.getElementById('tratamento-slug');
      
      // Remover listeners anteriores se existirem
      const novoNomeInput = nomeInput.cloneNode(true);
      nomeInput.parentNode.replaceChild(novoNomeInput, nomeInput);
      
      // Adicionar novo listener
      document.getElementById('tratamento-nome').addEventListener('input', function(e) {
        const nome = e.target.value.trim();
        const currentSlug = slugInput.value.trim();
        
        // S√≥ gerar slug automaticamente se:
        // 1. N√£o est√° editando (ou seja, √© novo tratamento)
        // 2. O campo slug est√° vazio
        // 3. O usu√°rio n√£o editou manualmente o slug recentemente
        if (!isEdit && !currentSlug && nome) {
          slugInput.value = generateSlug(nome);
        }
      });
    }

    async function loadTratamentoData(id) {
      const errorDiv = document.getElementById('modal-tratamento-error');
      errorDiv.innerHTML = '';

      if (!id || id === 'null' || id === 'undefined' || id === '') {
        errorDiv.innerHTML = '<div class="error">Erro: ID do tratamento inv√°lido</div>';
        return;
      }

      try {
        console.log('Carregando tratamento com ID:', id);
        
        const response = await fetch(`${API_URL}/tratamentos/id/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (data.success && data.data) {
          const t = data.data;
          console.log('Tratamento carregado:', t);
          
          // Garantir que o ID est√° sendo salvo
          const idInput = document.getElementById('tratamento-id');
          if (idInput) {
            idInput.value = t.id || id;
            console.log('ID salvo no campo hidden:', idInput.value);
          }
          
          document.getElementById('tratamento-nome').value = t.nome || '';
          document.getElementById('tratamento-descricao').value = t.descricao || '';
          document.getElementById('tratamento-slug').value = t.slug || '';
          document.getElementById('tratamento-imagem').value = t.imagem || '';
          document.getElementById('tratamento-ativo').checked = t.ativo !== false;
        } else {
          errorDiv.innerHTML = `<div class="error">Erro ao carregar tratamento: ${data.error?.message || 'Tratamento n√£o encontrado'}</div>`;
        }
      } catch (error) {
        console.error('Erro ao carregar tratamento:', error);
        errorDiv.innerHTML = `<div class="error">Erro ao carregar tratamento: ${error.message}</div>`;
      }
    }

    async function saveTratamento(e) {
      e.preventDefault();
      const errorDiv = document.getElementById('modal-tratamento-error');
      errorDiv.innerHTML = '';

      const idInput = document.getElementById('tratamento-id');
      const id = idInput ? idInput.value.trim() : '';
      const nome = document.getElementById('tratamento-nome').value.trim();
      const descricao = document.getElementById('tratamento-descricao').value.trim();
      const slug = document.getElementById('tratamento-slug').value.trim();
      const imagem = document.getElementById('tratamento-imagem').value.trim();
      const ativo = document.getElementById('tratamento-ativo').checked;

      // Validar nome obrigat√≥rio
      if (!nome) {
        errorDiv.innerHTML = '<div class="error">Nome √© obrigat√≥rio</div>';
        return;
      }

      // Se est√° editando, validar ID
      const isEdit = id && id !== '' && id !== 'null' && id !== 'undefined';
      
      if (isEdit && !id) {
        errorDiv.innerHTML = '<div class="error">Erro: ID do tratamento n√£o encontrado. Recarregue a p√°gina e tente novamente.</div>';
        return;
      }

      // Preparar dados - remover campos vazios para update
      const data = {
        nome,
        ativo
      };

      // Adicionar campos opcionais apenas se preenchidos
      if (descricao) data.descricao = descricao;
      // Slug √© opcional - backend gera automaticamente se n√£o fornecido
      // S√≥ enviar se foi preenchido manualmente
      if (slug && slug.trim()) {
        data.slug = slug.trim();
      }
      if (imagem) data.imagem = imagem;

      try {
        // Validar ID uma √∫ltima vez antes de enviar
        if (isEdit && (!id || id === '' || id === 'null' || id === 'undefined')) {
          errorDiv.innerHTML = '<div class="error">Erro: ID do tratamento inv√°lido ou n√£o encontrado. Por favor, feche o modal e tente editar novamente.</div>';
          console.error('ID inv√°lido ao salvar:', id);
          return;
        }

        // Construir URL usando API_URL configurada (produ√ß√£o ou local)
        let url;
        const baseUrl = API_URL.endsWith('/tratamentos')
          ? API_URL
          : `${API_URL.replace(/\/$/, '')}/tratamentos`;
        if (isEdit) {
          url = `${baseUrl}/${id}`;
        } else {
          url = baseUrl;
        }
        
        const method = isEdit ? 'PUT' : 'POST';

        console.log('=== SALVANDO TRATAMENTO ===');
        console.log('ID:', id);
        console.log('isEdit:', isEdit);
        console.log('API_URL:', API_URL);
        console.log('URL completa constru√≠da:', url);
        console.log('URL cont√©m /tratamentos/ (plural):', url.includes('/tratamentos/'));
        console.log('Method:', method);
        console.log('Data:', data);
        console.log('Token presente:', !!token);
        console.log('===========================');

        // Criar um novo objeto URL para validar
        try {
          const urlObj = new URL(url);
          console.log('URL validada:', urlObj.href);
        } catch (urlError) {
          console.error('Erro ao validar URL:', urlError);
          errorDiv.innerHTML = `<div class="error">Erro: URL inv√°lida. ${urlError.message}</div>`;
          return;
        }

        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        console.log('Status da resposta:', response.status);
        console.log('Status text:', response.statusText);

        const result = await response.json();
        console.log('Resposta do servidor:', result);

        if (response.ok) {
          closeTratamentoModal();
          loadTratamentos();
          loadStats();
        } else {
          // Mostrar detalhes do erro de valida√ß√£o
          let errorMsg = result.error?.message || 'Erro ao salvar tratamento';
          if (result.error?.details && Array.isArray(result.error.details)) {
            errorMsg += '<br>' + result.error.details.map(d => `- ${d.message || d}`).join('<br>');
          }
          errorDiv.innerHTML = `<div class="error">${errorMsg}</div>`;
        }
      } catch (error) {
        errorDiv.innerHTML = `<div class="error">Erro: ${error.message}</div>`;
      }
    }

    async function editTratamento(id) {
      openTratamentoModal(id);
    }

    async function deleteTratamento(id, nome) {
      if (!confirm(`Tem certeza que deseja excluir o tratamento "${nome}"?`)) return;

      try {
        const response = await fetch(`${API_URL}/tratamentos/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          loadTratamentos();
          loadStats();
        } else {
          const data = await response.json();
          alert(data.error?.message || 'Erro ao excluir tratamento');
        }
      } catch (error) {
        alert(`Erro: ${error.message}`);
      }
    }

    function closeTratamentoModal() {
      document.getElementById('modal-tratamento').classList.remove('active');
    }

    // ============ AGENDAMENTOS ============
    function filterAgendamentos(status) {
      currentAgendamentoFilter = status;
      document.querySelectorAll('.filters button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      loadAgendamentos();
    }

    async function loadAgendamentos() {
      const loading = document.getElementById('agendamentos-loading');
      const table = document.getElementById('agendamentos-table');
      const body = document.getElementById('agendamentos-body');

      try {
        loading.style.display = 'block';
        table.style.display = 'none';

        let url = `${API_URL}/agendamento?limit=100&order=desc`;
        if (currentAgendamentoFilter) {
          url += `&status=${currentAgendamentoFilter}`;
        }

        console.log('üì• Carregando agendamentos do admin:', url);
        
        // Usar apiRequest helper que faz refresh autom√°tico
        const response = await apiRequest(url, {
          method: 'GET',
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`‚ùå Erro HTTP ${response.status}:`, errorText);
          throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
        }

        const data = await response.json();
        console.log('‚úÖ Agendamentos recebidos:', data);
        console.log(`üìä Total: ${data.data?.length || 0} agendamentos`);

        if (data.success && data.data && Array.isArray(data.data)) {
          loading.style.display = 'none';
          table.style.display = 'table';

          if (data.data.length === 0) {
            body.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Nenhum agendamento encontrado</td></tr>';
          } else {
            body.innerHTML = data.data.map(ag => `
            <tr>
              <td>${new Date(ag.dataAgendada || ag.dataEnvio || ag.criadoEm).toLocaleDateString('pt-BR')}</td>
              <td>${ag.nome}</td>
              <td>${ag.email}</td>
              <td>${ag.telefone}</td>
              <td>${ag.tratamento?.nome || 'N/A'}</td>
              <td><span class="status ${ag.status?.toLowerCase() || 'pendente'}">${ag.status || 'PENDENTE'}</span></td>
              <td class="actions">
                <select onchange="updateAgendamentoStatus('${ag.id}', this.value)" class="btn-small">
                  <option value="PENDENTE" ${ag.status === 'PENDENTE' ? 'selected' : ''}>Pendente</option>
                  <option value="CONFIRMADO" ${ag.status === 'CONFIRMADO' ? 'selected' : ''}>Confirmar</option>
                  <option value="CANCELADO" ${ag.status === 'CANCELADO' ? 'selected' : ''}>Cancelar</option>
                </select>
                <button class="btn-small danger" onclick="deleteAgendamento('${ag.id}', '${(ag.nome || '').replace(/'/g, "\\'")}')">Excluir</button>
              </td>
            </tr>
          `).join('');
          }
        } else {
          loading.style.display = 'none';
          body.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">Nenhum agendamento encontrado</td></tr>';
          console.warn('‚ö†Ô∏è Resposta da API n√£o cont√©m dados v√°lidos:', data);
        }
      } catch (error) {
        loading.innerHTML = `<div class="error">Erro ao carregar agendamentos: ${error.message}</div>`;
      }
    }

    async function updateAgendamentoStatus(id, status) {
      try {
        console.log(`üîÑ Atualizando status do agendamento ${id} para ${status}`);
        
        const response = await apiRequest(`${API_URL}/agendamento/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status })
        });

        if (response.ok) {
          console.log('‚úÖ Status atualizado com sucesso');
          loadAgendamentos();
          loadStats();
        } else {
          const data = await response.json();
          alert(data.error?.message || 'Erro ao atualizar status');
        }
      } catch (error) {
        console.error('‚ùå Erro ao atualizar status:', error);
        alert(`Erro: ${error.message}`);
      }
    }

    async function deleteAgendamento(id, nome) {
      if (!confirm(`Tem certeza que deseja excluir o agendamento de "${nome}"?`)) return;

      try {
        console.log(`üóëÔ∏è Excluindo agendamento ${id}...`);
        
        const response = await apiRequest(`${API_URL}/agendamento/${id}`, {
          method: 'DELETE',
        });

        if (response.ok) {
          console.log('‚úÖ Agendamento exclu√≠do com sucesso');
          loadAgendamentos();
          loadStats();
        } else {
          const data = await response.json();
          alert(data.error?.message || 'Erro ao excluir agendamento');
        }
      } catch (error) {
        console.error('‚ùå Erro ao excluir agendamento:', error);
        alert(`Erro: ${error.message}`);
      }
    }

    // Fun√ß√£o helper para processar resposta de avalia√ß√µes
    async function handleAvaliacoesResponse(response, loading, table, body) {
      const data = await response.json();
      console.log('‚úÖ Avalia√ß√µes recebidas:', data);
      console.log(`üìä Total: ${data.data?.length || 0} avalia√ß√µes`);

      console.log('üì¶ Processando resposta de avalia√ß√µes...');
      console.log('  - success:', data.success);
      console.log('  - data existe?', !!data.data);
      console.log('  - data √© array?', Array.isArray(data.data));
      console.log('  - quantidade:', data.data?.length || 0);
      
      if (data.success && data.data && Array.isArray(data.data)) {
        loading.style.display = 'none';
        table.style.display = 'table';

        if (data.data.length === 0) {
          body.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                <div style="margin-bottom: 10px;">üì≠ Nenhuma avalia√ß√£o encontrada no banco de dados</div>
                <div style="font-size: 0.9em; color: #999;">
                  As avalia√ß√µes criadas no site aparecer√£o aqui ap√≥s serem aprovadas.
                </div>
              </td>
            </tr>
          `;
          console.log('‚ö†Ô∏è Banco de dados est√° vazio para avalia√ß√µes');
        } else {
          body.innerHTML = data.data.map(av => `
          <tr>
            <td>${new Date(av.dataAvaliacao || av.criadoEm).toLocaleDateString('pt-BR')}</td>
            <td>${av.nome} ${av.avatar ? `(${av.avatar})` : ''}</td>
            <td>${'‚≠ê'.repeat(av.nota || 5)}</td>
            <td>${(av.texto || '').substring(0, 100)}${(av.texto || '').length > 100 ? '...' : ''}</td>
            <td>${av.aprovado ? '<span class="badge success">Sim</span>' : '<span class="badge danger">N√£o</span>'}</td>
            <td class="actions">
              <button class="btn-small" onclick="editAvaliacao('${av.id || ''}')">Editar</button>
              <button class="btn-small ${av.aprovado ? 'danger' : 'success'}" onclick="toggleAvaliacaoAprovado('${av.id || ''}', ${!av.aprovado})">
                ${av.aprovado ? 'Reprovar' : 'Aprovar'}
              </button>
              <button class="btn-small danger" onclick="deleteAvaliacao('${av.id || ''}', '${(av.nome || '').replace(/'/g, "\\'")}')">Excluir</button>
            </td>
          </tr>
        `).join('');
        }
      } else {
        loading.style.display = 'none';
        body.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: #d32f2f;">
              <div style="margin-bottom: 10px;">‚ö†Ô∏è Erro ao processar resposta da API</div>
              <div style="font-size: 0.9em; color: #999;">
                Verifique o console (F12) para mais detalhes.<br>
                Resposta recebida: ${JSON.stringify(data).substring(0, 200)}...
              </div>
            </td>
          </tr>
        `;
        console.error('‚ùå Resposta da API n√£o cont√©m dados v√°lidos:', data);
        console.error('  - Estrutura esperada: { success: true, data: [...] }');
      }
    }

    // ============ AVALIA√á√ïES ============
    async function loadAvaliacoes() {
      const loading = document.getElementById('avaliacoes-loading');
      const table = document.getElementById('avaliacoes-table');
      const body = document.getElementById('avaliacoes-body');

      try {
        loading.style.display = 'block';
        table.style.display = 'none';

        // Carregar TODAS as avalia√ß√µes (aprovadas e n√£o aprovadas) para o admin
        // IMPORTANTE: N√£o passar ?aprovado= para ver TODAS (aprovadas e n√£o aprovadas)
        const url = `${API_URL}/avaliacoes?limit=100&orderBy=dataAvaliacao&order=desc`;
        console.log('üì• Carregando avalia√ß√µes do admin:', url);
        console.log('üîë Token presente:', !!token);
        
        // Usar apiRequest helper que faz refresh autom√°tico
        const response = await apiRequest(url, {
          method: 'GET',
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`‚ùå Erro HTTP ${response.status}:`, errorText);
          
          // Tentar sem token se for 401 (rota p√∫blica, mas mostrar√° s√≥ aprovadas)
          if (response.status === 401) {
            console.log('‚ö†Ô∏è Tentando carregar sem autentica√ß√£o (mostrar√° apenas aprovadas)...');
            const publicResponse = await fetch(`${url}&aprovado=true`, {
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
              },
            });
            
            if (publicResponse.ok) {
              console.log('‚úÖ Carregado via rota p√∫blica (sem auth)');
              return await handleAvaliacoesResponse(publicResponse, loading, table, body);
            }
          }
          
          throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
        }

        return await handleAvaliacoesResponse(response, loading, table, body);
      } catch (error) {
        console.error('‚ùå Erro ao carregar avalia√ß√µes:', error);
        console.error('  - Tipo:', error.name);
        console.error('  - Mensagem:', error.message);
        console.error('  - Stack:', error.stack);
        
        loading.style.display = 'none';
        const errorMsg = error.message || 'Erro desconhecido';
        loading.innerHTML = `
          <div class="error" style="padding: 20px; text-align: center;">
            <strong>‚ùå Erro ao carregar avalia√ß√µes</strong><br>
            <small>${errorMsg}</small><br><br>
            <button onclick="loadAvaliacoes()" class="btn-small" style="margin-top: 10px;">üîÑ Tentar Novamente</button>
            <button onclick="diagnoseConnection()" class="btn-small" style="margin-top: 10px;">üîç Diagnosticar Conex√£o</button>
          </div>
        `;
      }
    }

    function openAvaliacaoModal(id = null) {
      const modal = document.getElementById('modal-avaliacao');
      const title = document.getElementById('modal-avaliacao-title');
      const form = document.getElementById('form-avaliacao');
      
      form.reset();
      document.getElementById('modal-avaliacao-error').innerHTML = '';
      document.getElementById('avaliacao-id').value = '';
      
      if (id && id !== 'null' && id !== 'undefined') {
        title.textContent = 'Editar Avalia√ß√£o';
        loadAvaliacaoData(id);
      } else {
        title.textContent = 'Nova Avalia√ß√£o';
        document.getElementById('avaliacao-aprovado').checked = true;
      }
      
      modal.classList.add('active');
    }

    async function loadAvaliacaoData(id) {
      if (!id || id === 'null' || id === 'undefined') {
        document.getElementById('modal-avaliacao-error').innerHTML = 
          `<div class="error">Erro: ID da avalia√ß√£o inv√°lido</div>`;
        return;
      }

      try {
        const response = await fetch(`${API_URL}/avaliacoes/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (data.success && data.data) {
          const av = data.data;
          document.getElementById('avaliacao-id').value = av.id;
          document.getElementById('avaliacao-nome').value = av.nome || '';
          document.getElementById('avaliacao-avatar').value = av.avatar || '';
          document.getElementById('avaliacao-nota').value = av.nota || 5;
          document.getElementById('avaliacao-texto').value = av.texto || '';
          document.getElementById('avaliacao-aprovado').checked = av.aprovado !== false;
        } else {
          document.getElementById('modal-avaliacao-error').innerHTML = 
            `<div class="error">Erro ao carregar avalia√ß√£o: ${data.error?.message || 'Avalia√ß√£o n√£o encontrada'}</div>`;
        }
      } catch (error) {
        document.getElementById('modal-avaliacao-error').innerHTML = 
          `<div class="error">Erro ao carregar avalia√ß√£o: ${error.message}</div>`;
      }
    }

    async function saveAvaliacao(e) {
      e.preventDefault();
      const errorDiv = document.getElementById('modal-avaliacao-error');
      errorDiv.innerHTML = '';

      const id = document.getElementById('avaliacao-id').value;
      const nome = document.getElementById('avaliacao-nome').value.trim();
      const avatar = document.getElementById('avaliacao-avatar').value.trim();
      const notaValue = document.getElementById('avaliacao-nota').value;
      const texto = document.getElementById('avaliacao-texto').value.trim();
      const aprovado = document.getElementById('avaliacao-aprovado').checked;

      // Valida√ß√µes b√°sicas
      if (!nome || nome.length < 3) {
        errorDiv.innerHTML = '<div class="error">Nome deve ter no m√≠nimo 3 caracteres</div>';
        return;
      }

      if (!texto || texto.length < 10) {
        errorDiv.innerHTML = '<div class="error">Texto deve ter no m√≠nimo 10 caracteres</div>';
        return;
      }

      const nota = parseInt(notaValue);
      if (isNaN(nota) || nota < 1 || nota > 5) {
        errorDiv.innerHTML = '<div class="error">Nota deve ser um n√∫mero entre 1 e 5</div>';
        return;
      }

      // Preparar dados
      const data = {
        nome: nome,
        nota: nota,
        texto: texto,
        aprovado: aprovado
      };

      // Adicionar avatar apenas se preenchido
      if (avatar) {
        data.avatar = avatar;
      }

      console.log('üì§ Enviando avalia√ß√£o:', data);
      console.log('URL:', id ? `${API_URL}/avaliacoes/${id}` : `${API_URL}/avaliacoes`);

      try {
        const url = id ? `${API_URL}/avaliacoes/${id}` : `${API_URL}/avaliacoes`;
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        console.log('üì• Resposta recebida:', response.status, response.statusText);

        const result = await response.json();
        console.log('üì• Dados da resposta:', result);

        if (response.ok && result.success) {
          console.log('‚úÖ Avalia√ß√£o salva com sucesso!', result);
          alert(result.message || 'Avalia√ß√£o salva com sucesso!');
          closeAvaliacaoModal();
          // Aguardar um pouco antes de recarregar para garantir que o backend processou
          setTimeout(() => {
            loadAvaliacoes();
            loadStats();
          }, 500);
        } else {
          console.error('‚ùå Erro ao salvar avalia√ß√£o:', result);
          let errorMsg = result.error?.message || 'Erro ao salvar avalia√ß√£o';
          if (result.error?.details && Array.isArray(result.error.details)) {
            errorMsg += '<br><br><strong>Detalhes:</strong><br>' + result.error.details.map(d => `‚Ä¢ ${d.path || ''}: ${d.message || d}`).join('<br>');
          }
          errorDiv.innerHTML = `<div class="error">${errorMsg}</div>`;
        }
      } catch (error) {
        console.error('‚ùå Erro ao enviar requisi√ß√£o:', error);
        errorDiv.innerHTML = `<div class="error">Erro ao enviar requisi√ß√£o: ${error.message}</div>`;
      }
    }

    async function editAvaliacao(id) {
      openAvaliacaoModal(id);
    }

    async function toggleAvaliacaoAprovado(id, aprovado) {
      try {
        const response = await fetch(`${API_URL}/avaliacoes/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ aprovado })
        });

        if (response.ok) {
          loadAvaliacoes();
          loadStats();
        } else {
          const data = await response.json();
          alert(data.error?.message || 'Erro ao atualizar avalia√ß√£o');
        }
      } catch (error) {
        alert(`Erro: ${error.message}`);
      }
    }

    async function deleteAvaliacao(id, nome) {
      if (!confirm(`Tem certeza que deseja excluir a avalia√ß√£o de "${nome}"?`)) return;

      try {
        const response = await fetch(`${API_URL}/avaliacoes/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          loadAvaliacoes();
          loadStats();
        } else {
          const data = await response.json();
          alert(data.error?.message || 'Erro ao excluir avalia√ß√£o');
        }
      } catch (error) {
        alert(`Erro: ${error.message}`);
      }
    }

    function closeAvaliacaoModal() {
      document.getElementById('modal-avaliacao').classList.remove('active');
    }

    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminRefreshToken');
      token = null;
      refreshToken = null;
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('dashboard').classList.remove('active');
      console.log('üëã Logout realizado');
    }
  </script>
</body>
</html>
